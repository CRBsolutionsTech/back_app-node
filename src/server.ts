import fastify from "fastify";
import { supabase } from "./supabaseConnection";
import bcrypt from "bcryptjs";

const app = fastify();

type Users = {
    name: string;
    email: string;
    password: string;
    registro: string;
    cpf: string;
    celular: string;
};

// ‚úÖ Rota principal (Home)
app.get("/", async (request, reply) => {
    return reply.send({ message: "üöÄ API Fastify rodando com sucesso!" });
});

// ‚úÖ Rota GET - Buscar usu√°rios
app.get("/register", async (request, reply) => {
    try {
        const { data: register, error } = await supabase.from("register").select("*");
        if (error) throw new Error(error.message);

        return reply.send({ register });
    } catch (error) {
        console.error("Erro ao buscar usu√°rios:", error);
        return reply.status(500).send({ error: "Erro ao buscar usu√°rios." });
    }
});

// ‚úÖ Rota POST - Criar usu√°rio
app.post("/register", async (request, reply) => {
    try {
        console.log("Dados recebidos:", request.body); // üëÄ Verificar dados

        const { name, email, password, registro, cpf, celular } = request.body as Users;

        if (!name || !email || !password || !registro || !cpf || !celular) {
            return reply.status(400).send({ error: "Todos os campos s√£o obrigat√≥rios." });
        }

        const hashedPassword = await bcrypt.hash(password, 10);

        const { data: createdUser, error } = await supabase
            .from("register")
            .insert([{ name, email, password: hashedPassword, registro, cpf, celular }])
            .select();

        if (error) return reply.status(400).send({ error: error.message });

        return reply.status(201).send({ register: createdUser ? createdUser[0] : null });
    } catch (error) {
        console.error("Erro ao criar usu√°rio:", error);
        return reply.status(500).send({ error: "Erro ao criar usu√°rio." });
    }
});

// ‚úÖ Rota POST - Resetar senha pelo e-mail
app.post("/reset-password", async (request, reply) => {
    try {
        const { email, newPassword } = request.body as { email: string; newPassword: string };

        if (!email || !newPassword) {
            return reply.status(400).send({ error: "E-mail e nova senha s√£o obrigat√≥rios." });
        }

        // üîç Verifica se o e-mail existe
        const { data: user, error: userError } = await supabase
            .from("register")
            .select("email")
            .eq("email", email)
            .single();

        if (userError || !user) {
            return reply.status(404).send({ error: "Usu√°rio n√£o encontrado." });
        }

        // üîí Criptografa a nova senha
        const hashedPassword = await bcrypt.hash(newPassword, 10);

        // üîÑ Atualiza a senha no banco
        const { error } = await supabase
            .from("register")
            .update({ password: hashedPassword })
            .eq("email", email);

        if (error) return reply.status(400).send({ error: error.message });

        return reply.send({ message: "Senha redefinida com sucesso!" });

    } catch (error) {
        console.error("Erro ao redefinir senha:", error);
        return reply.status(500).send({ error: "Erro ao redefinir senha." });
    }
});

// ‚úÖ Iniciar servidor
app.listen({
    host: "0.0.0.0",
    port: process.env.PORT ? Number(process.env.PORT) : 3333,
}).then(() => {
    console.log("‚úÖ Servidor Funcionando!");
}).catch(err => {
    console.error("‚ùå Erro ao iniciar servidor:", err);
    process.exit(1);
});
